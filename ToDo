import sys
from PyQt6.QtWidgets import (
    QApplication, QWidget, QVBoxLayout, QHBoxLayout,
    QListWidget, QListWidgetItem, QLineEdit, QPushButton,
    QDialog, QTextEdit, QFormLayout, QDialogButtonBox,
    QAbstractItemView, QLabel  
)
from PyQt6.QtCore import Qt


class EditTaskDialog(QDialog):

    def __init__(self, title, notes, parent=None):
        super().__init__(parent)

        self.title_edit = QLineEdit(title)
        self.notes_edit = QTextEdit(notes)
        self.notes_edit.setMinimumHeight(100)

        self.button_box = QDialogButtonBox(
            QDialogButtonBox.StandardButton.Ok | QDialogButtonBox.StandardButton.Cancel
        )

        layout = QFormLayout(self)
        layout.addRow("Задача:", self.title_edit)
        layout.addRow("Заметки:", self.notes_edit)
        layout.addWidget(self.button_box)

        self.button_box.accepted.connect(self.accept)
        self.button_box.rejected.connect(self.reject)

        self.setWindowTitle("Редактировать задачу")

    def get_data(self):
        return self.title_edit.text().strip(), self.notes_edit.toPlainText().strip()


class ToDoApp(QWidget):


    def __init__(self):
        super().__init__()
        self.init_ui()

    def init_ui(self):


        self.title_label = QLabel("Ваши заметки")
        self.title_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.title_label.setStyleSheet("""
            QLabel {
                font-size: 20px;
                font-weight: bold;
                padding-top: 5px;
                padding-bottom: 5px;
            }
        """)


        self.task_list_widget = QListWidget()
        self.task_list_widget.setSelectionMode(
            QAbstractItemView.SelectionMode.ExtendedSelection
        )

        list_widget_stylesheet = """
            QListWidget {
                background-color: #f0f0f0; 
                border: none;             
                outline: 0;               
            }
            QListWidget::item {
                background-color: #ffffff; 
                border: 1px solid #cccccc; 
                border-radius: 5px;        
                padding: 8px;              
                margin-top: 5px;           
                margin-right: 5px;         
                margin-left: 5px;          
            }
            QListWidget::item:hover {
                background-color: #f5f5f5; 
                border-color: #bbbbbb;    
            }
            QListWidget::item:selected {
                background-color: #e8f0fe; 
                border: 1px solid #4a90e2;  
                color: #000000;             
            }
        """
        self.task_list_widget.setStyleSheet(list_widget_stylesheet)

        self.task_input = QLineEdit()
        self.task_input.setPlaceholderText("Введите новую задачу...")
        self.add_button = QPushButton("Добавить")
        self.remove_button = QPushButton("Удалить")


        main_layout = QVBoxLayout()

        main_layout.addWidget(self.title_label)

        input_layout = QHBoxLayout()
        input_layout.addWidget(self.task_input)
        input_layout.addWidget(self.add_button)

        main_layout.addWidget(self.task_list_widget)
        main_layout.addLayout(input_layout)
        main_layout.addWidget(self.remove_button)
        self.setLayout(main_layout)


        self.add_button.clicked.connect(self.add_task)
        self.task_input.returnPressed.connect(self.add_task)
        self.remove_button.clicked.connect(self.remove_task)
        self.task_list_widget.itemDoubleClicked.connect(self.edit_task)

        self.setWindowTitle("ToDo-лист")
        self.resize(350, 450)
        self.setStyleSheet("background-color: #f0f0f0;")

    def _create_display_text(self, title, notes):

        if not notes:
            return f"{title}\n  └ заметок нет"

        non_empty_lines = [line.strip() for line in notes.splitlines() if line.strip()]

        if not non_empty_lines:
            return f"{title}\n  └ заметок нет"

        snippet = non_empty_lines[0]
        add_ellipsis = False

        if len(non_empty_lines) > 1:
            add_ellipsis = True

        if len(snippet) > 30:
            snippet = snippet[:30]
            add_ellipsis = True

        if add_ellipsis and not snippet.endswith("..."):
            snippet += "..."

        return f"{title}\n  └ {snippet}"

    def add_task(self):
        task_text = self.task_input.text().strip()

        if task_text:
            notes = ""
            item = QListWidgetItem()

            item.setText(self._create_display_text(task_text, notes))
            item.setData(Qt.ItemDataRole.UserRole, notes)
            item.setData(Qt.ItemDataRole.UserRole + 1, task_text)

            self.task_list_widget.addItem(item)
            self.task_input.clear()

    def remove_task(self):
        selected_items = self.task_list_widget.selectedItems()
        if not selected_items:
            return
        for item in selected_items:
            self.task_list_widget.takeItem(self.task_list_widget.row(item))

    def edit_task(self, item):
        current_title = item.data(Qt.ItemDataRole.UserRole + 1)
        current_notes = item.data(Qt.ItemDataRole.UserRole) or ""

        dialog = EditTaskDialog(current_title, current_notes, self)

        if dialog.exec():
            new_title, new_notes = dialog.get_data()

            item.setText(self._create_display_text(new_title, new_notes))
            item.setData(Qt.ItemDataRole.UserRole, new_notes)
            item.setData(Qt.ItemDataRole.UserRole + 1, new_title)


if __name__ == '__main__':
    app = QApplication(sys.argv)
    window = ToDoApp()
    window.show()
    sys.exit(app.exec())
